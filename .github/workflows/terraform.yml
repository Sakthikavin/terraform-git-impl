name: Terraform GitHub App Auth

on:
  workflow_dispatch:

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - name: Get user information
        id: user-info
        run: |
          # Get user info from GitHub API
          USER_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/users/${{ github.actor }})
          
          # Extract name and email
          GITHUB_NAME=$(echo $USER_INFO | jq -r '.name // .login')
          GITHUB_EMAIL=$(echo $USER_INFO | jq -r '.email // empty')
          
          # If email is not public, use noreply email
          if [ -z "$GITHUB_EMAIL" ] || [ "$GITHUB_EMAIL" == "null" ]; then
            GITHUB_EMAIL="${{ github.actor }}@users.noreply.github.com"
          fi
          
          echo "commit_author=$GITHUB_NAME" >> $GITHUB_OUTPUT
          echo "commit_email=$GITHUB_EMAIL" >> $GITHUB_OUTPUT
          
          echo "User: $GITHUB_NAME <$GITHUB_EMAIL>"

      - name: Create private key file
        run: |
          echo "${{ secrets.APP_PRIVATE_KEY }}" > poc/private-key.pem
          chmod 600 poc/private-key.pem

      - name: Terraform Init
        working-directory: ./poc
        env:
          TF_VAR_app_id: ${{ secrets.APP_ID }}
          TF_VAR_app_installation_id: ${{ secrets.APP_INSTALLATION_ID }}
          TF_VAR_commit_author: ${{ steps.user-info.outputs.commit_author }}
          TF_VAR_commit_email: ${{ steps.user-info.outputs.commit_email }}
        run: terraform init

      - name: Terraform Apply
        id: apply
        working-directory: ./poc
        env:
          TF_VAR_app_id: ${{ secrets.APP_ID }}
          TF_VAR_app_installation_id: ${{ secrets.APP_INSTALLATION_ID }}
          TF_VAR_commit_author: ${{ steps.user-info.outputs.commit_author }}
          TF_VAR_commit_email: ${{ steps.user-info.outputs.commit_email }}
        run: |
          terraform apply -auto-approve
          terraform output -raw pull_request_url > pr_url.txt

      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: Sakthikavin
          repositories: AlbumAssist

      - name: Comment on PR
        if: steps.apply.outcome == 'success'
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          PR_URL=$(cat pr_url.txt)
          echo "Adding comment to PR: $PR_URL"
          PR_NUMBER=$(echo "$PR_URL" | sed 's|.*/pull/||')
          GITHUB_ORG=$(echo "$PR_URL" | sed 's|https://github.com/||' | cut -d'/' -f1)
          REPO_NAME=$(echo "$PR_URL" | sed 's|https://github.com/||' | cut -d'/' -f2)
          
          gh pr comment "$PR_NUMBER" --repo "$GITHUB_ORG/$REPO_NAME" --body-file - << 'EOF'
          ðŸ‘‹ Hey team,

          This PR was created and configured by Terraform automation:
          - âœ… AttachDataSource ADS configuration added
          - âœ… Kafka source adapter setup
          - âœ… GitHub Actions workflow for validation

          Please review the ADS JSON and access controls.
          
          ðŸ¤– Auto-generated via Terraform in workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF
        working-directory: ./poc
