name: Terraform with Interactive Login

on:
  workflow_dispatch:

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - name: GitHub Device Flow Login
        id: gh-login
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” GitHub Authentication Required"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Authenticate with GitHub (will show device code)
          gh auth login --web --scopes repo,workflow
          
          # Get the authenticated token
          GH_TOKEN=$(gh auth token)
          
          # Mask token in logs
          echo "::add-mask::$GH_TOKEN"
          echo "github_token=$GH_TOKEN" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Authentication successful!"

      - name: Get user information
        id: user-info
        env:
          GH_TOKEN: ${{ steps.gh-login.outputs.github_token }}
        run: |
          # Get authenticated user info
          USER_INFO=$(gh api /user)
          
          GITHUB_NAME=$(echo $USER_INFO | jq -r '.name // .login')
          GITHUB_EMAIL=$(echo $USER_INFO | jq -r '.email // empty')
          GITHUB_USERNAME=$(echo $USER_INFO | jq -r '.login')
          
          # Fallback to noreply email
          if [ -z "$GITHUB_EMAIL" ] || [ "$GITHUB_EMAIL" == "null" ]; then
            GITHUB_EMAIL="${GITHUB_USERNAME}@users.noreply.github.com"
          fi
          
          echo "commit_author=$GITHUB_NAME" >> $GITHUB_OUTPUT
          echo "commit_email=$GITHUB_EMAIL" >> $GITHUB_OUTPUT
          
          echo "âœ… Authenticated as: $GITHUB_NAME (@$GITHUB_USERNAME)"

      - name: Terraform Init
        working-directory: ./poc
        env:
          TF_VAR_github_token: ${{ steps.gh-login.outputs.github_token }}
          TF_VAR_commit_author: ${{ steps.user-info.outputs.commit_author }}
          TF_VAR_commit_email: ${{ steps.user-info.outputs.commit_email }}
        run: terraform init

      - name: Terraform Apply
        id: apply
        working-directory: ./poc
        env:
          TF_VAR_github_token: ${{ steps.gh-login.outputs.github_token }}
          TF_VAR_commit_author: ${{ steps.user-info.outputs.commit_author }}
          TF_VAR_commit_email: ${{ steps.user-info.outputs.commit_email }}
        run: |
          terraform apply -auto-approve
          terraform output -raw pull_request_url > pr_url.txt
          
          echo ""
          echo "âœ… Pull Request Created: $(cat pr_url.txt)"

      - name: Comment on PR
        if: steps.apply.outcome == 'success'
        env:
          GH_TOKEN: ${{ steps.gh-login.outputs.github_token }}
        run: |
          PR_URL=$(cat pr_url.txt)
          PR_NUMBER=$(echo "$PR_URL" | sed 's|.*/pull/||')
          GITHUB_ORG=$(echo "$PR_URL" | sed 's|https://github.com/||' | cut -d'/' -f1)
          REPO_NAME=$(echo "$PR_URL" | sed 's|https://github.com/||' | cut -d'/' -f2)
          
          gh pr comment "$PR_NUMBER" --repo "$GITHUB_ORG/$REPO_NAME" --body "ðŸ‘‹ Hey team,

          This PR was created by **${{ steps.user-info.outputs.commit_author }}** via Terraform automation:
          - âœ… AttachDataSource ADS configuration
          - âœ… Kafka source adapter configured
          - âœ… GitHub Actions workflow

          Please review the ADS JSON and access controls.
          
          ðŸ¤– _Auto-generated via Terraform - Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}_"
        working-directory: ./poc

      - name: Cleanup
        if: always()
        run: gh auth logout --hostname github.com || true
